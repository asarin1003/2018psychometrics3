---
title: "2018春心理科学統計III　Rによる分析チュートリアル"
author: 'MIURA Asako (Kwansei Gakuin Univ / Osaka Univ)'
date: "`r Sys.Date()`"
output: 
 html_document:
  md_extensions: -ascii_identifiers
  toc: true
  toc_depth: 4
  toc_float: true
  number_section: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 講義内容

- 「心理科学基礎統計」「心理科学統計I/II」などで学んだ統計解析手法を，データ解析に活用する方法を，フリーの統計分析プログラム「HAD」を用いて実践的に学ぶ  
- データ解析の結果をレポート・論文で正しく記述するためのルールを学ぶ  
- 卒業論文で，実験・調査などを通じて数量的なデータを収集し，実証的な研究をする学生を主たる対象として想定した授業を進める  
- 心理統計に関しては記述統計学と推測統計学（統計的仮説検定）の知識，パソコン操作に関しては情報処理基礎の知識を前提とした講義を行う  
- 授業時間外にも自主的に予習・復習を行う事が強く求められる  

本ドキュメントは，こうした講義内容を「R」で再現するものである.HADは分析内容（すべてではない）をRコードとして出力するオプションがある．データシート「HAD2R」から「HAR2Rをオンにする」にチェックを入れて，分析を実行すればよい．このチュートリアルでは一部にこのオプションを活用している.  

---

# Rによる分析環境の整備  

Rはフリーの統計解析向けのプログラミング言語で，すべての機能が無料で使える一方で高い拡張性を持つため，急速に普及している．  

> 清水先生談：[本格的に統計分析を学習・利用したい人は、Rなどのフリープログラムがオススメです。](http://norimune.net/696)  

本チュートリアルではRやパッケージのインストール方法など，基本的な環境整備については解説しないが，数多くの参考情報（書籍，Webサイト（例えば[ここ](http://www.okadajp.org/RWiki/?R%20%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB)など）をすぐに見つけることができるだろう．また，Rによる統計解析をスムーズに実行・管理可能な統合環境として[RStudio](https://www.rstudio.com/)がある．これも無償版で十分活用できるので，是非導入を勧めたい．  p

本チュートリアルは，RStudioでR markdown(Rmd)パッケージによって作成された．種々の参考資料を活用しているが，特に[高橋康介『再現可能性のすゝめ―RStudioによるデータ解析とレポート作成―』（共立出版）](http://www.kyoritsu-pub.co.jp/bookdetail/9784320112438)がもっとも有用だった．こうしたチュートリアルを書く着想を与えてくれた同書と高橋さんに心から感謝する．  


```{r initialize, warning=FALSE, message=FALSE}
#このチュートリアルで使用するパッケージをすべてまとめてここで読み込んでおく．事前にインストールされている必要がある
library(psy)
library(psych)
library(effsize)
library(ggplot2)

#このチュートリアルで使用するデータもすべてまとめて読み込んでおく
dat <- read.csv("2018psychometrics3.csv", header=TRUE, fileEncoding="utf-8")
dat2 <- read.csv("2018psychometrics3_2.csv", header=TRUE, fileEncoding="utf-8")
dat3 <- read.csv("paired_sample.csv", header=TRUE, fileEncoding="utf-8")
dat4 <- read.csv("anova_sample2.csv", header=TRUE, fileEncoding="utf-8")
```

---

# サンプルデータに関する情報

基本は毎年度使用している以下の質問紙調査データ  

- [質問紙調査票](https://www.dropbox.com/s/jffr6jjrgygf81x/2018%E5%BF%83%E7%90%86%E7%A7%91%E5%AD%A6%E7%B5%B1%E8%A8%88III%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E8%B3%AA%E5%95%8F%E7%B4%99.pdf?dl=0)  
- [調査票プレビュー](https://kgpsysci.au1.qualtrics.com/jfe/preview/SV_3pF9vc4UbnixB7T?Q_CHL=preview)  

## 使用した尺度  

- 個人属性（性別・年齢）  
- 成人の愛着スタイル  
    - ヘイザンとシェイバー(1987)によって作成された，乳幼児の愛着パターンにもとづく3類型（安定・回避・アンビバレント）によって個人の愛着スタイルを判別する尺度
- IMC  
    - 質問紙調査の回答者が「努力の最小限化（Satisficing）をしていないかどうかを確認する設問．様々な方法があるが，IMCは，教示文をきちんと読んでいることを確認する目的で実施するもの  
- 孤独感  
    - ラッセルら(1978,1980)が作成したUCLA孤独感尺度を諸井(1985,1987,1991)が日本語に翻訳したもの．1～4の4件法  
- 主観的幸福感  
    - 本研究で独自に作成したもの．「楽しい」「満足な」「幸福な」「ゆううつな」「悲しい」の4項目．1（まったく当てはまらない）から100（ぴったり当てはまる）の101件法  
- 性格の5因子尺度  
    - 和田(1996)による特性形容詞を用いた尺度から5因子×6項目ずつ抽出したもの．1～7の7件法  

---

# 分析

## データの概要を知る  

最初に使用するデータは**```dat; ファイル名は 2018psychometrics3.csv```** である．

以下のスクリプトで，`dat`データセットの冒頭5行を表示してみよう．

```{r, eval=FALSE}
head(dat, 5)
knitr::kable(head(dat, 5))
```
```{r, echo=FALSE}
knitr::kable(head(dat, 5))
```


上記したデータファイル読み込みコマンドにも明記しているとおり，Rmdファイルもデータファイルも文字コードを**```UTF-8```**にしている．Excelでデータを開く時は「ファイル」→「開く」ではなく「データ」→「テキストファイル」を用いる必要がある．なお，Windowsの標準文字コードはShift-JISである．  

Rでは値にラベルをつけにくいので，名義尺度で測定された変数（性別と愛着スタイル）はデータそものを文字列データに変換した（性別は1男性・2女性，愛着スタイルは1安定・2回避・3アンビバレント）．
  
データ分析に着手する前に，まず全体にざっと目を通した上で，基本的な統計量や度数分布を見て，特徴を把握しておくことが重要である．それぞれどの関数を用いればよいかを把握しておこう．これらの関数はすべてRをインストールすれば必ず入っている  

```{r simple, warning=FALSE}
summary(dat) #すべての変数について基本統計量（最大値，最小値，平均値，中央値）を算出
summary(dat$年齢) #特定の1つの変数について基本統計量を算出
apply(dat[,5:24],2,summary)　#特定の列範囲（5～24，2で列単位算出を指定（行単位なら1）の変数について出力
apply(dat[,25:29],2,sd) #特定の列範囲（25～29列の変数）について標準偏差を算出

table(dat$主観的幸福感1) #度数分布表の出力
hist(dat$主観的幸福感1) #ヒストグラムの出力
```

なおapplyのオプションとしては，基本統計量summary,合計sum,平均mean,最大値max,最小値min,範囲range,中央値median,分散var,標準偏差sd,分位数quantileがある．  

データに欠損値が含まれる場合に，それを除外して統計量を算出する場合がほとんどだろう．今回講義で用いたデータには欠損値は含まれていないが，含まれる場合は，各コードに ```**na.rm=TRUE**``` というオプションをつけて実行する必要がある時もある（それぞれの関数のデフォルト設定に依存する）．  
  
また，**心理統計でよく用いられる分析のための関数をまとめたパッケージ[psych](https://cran.r-project.org/web/packages/psych/psych.pdf)**を活用するのもよいだろう．例えば上記の基本統計量や散布度など代表的な記述統計量を算出するdescribe関数や，それを群ごとに算出するdescribeBy関数，ヒストグラムに確率密度曲線と正規分布曲線を重ねて描画するmulti.hist関数などがある．  

describeの出力は，左から順に，列番号(var)，ケース数(n)，平均値(mean)，標準偏差(sd)，中央値(median)，トリムされた平均値(trimmed)，MAD:median absolute deviation(mad)，最小値(min)，最大値(max)，レンジ(range)，歪度(skew)，尖度(kurtosis)，標準誤差(se)である．  

```{r simplepsych, warning=FALSE}
describe(dat[,25:29]) #特定の列範囲（25～29列の変数）について代表的な記述統計量を算出
describeBy(dat[,25:29],dat$性別) #上記を性別毎に算出
multi.hist(dat$主観的幸福感1) #ヒストグラムに確率密度曲線とと正規分布曲線を重ねて描画
```

---

## 合成変数を作成する

個人の性格や態度，感情状態などを測定する「尺度」はたいてい複数項目から構成されている．これらをひとまとめにした変数を作成し，分析に用いる．ここでは，孤独感を構成する全20項目の情報を含めた，総合的な孤独感をあらわす新しい変数を作成してみる．このような変数のことをよく**```合成変数```**とよぶ． 
  
合成変数の作成方法（つまり複数項目の回答のまとめ方）はいろいろあるが，どの項目も同じ「重み」を持っていると見なして，得点が高ければ高いほど「総合的に見て孤独だと感じている程度が高い」ことを示す指標を作成するのがもっとも単純だろう.  
  
ここでは，孤独感を測定する20項目の合成変数を作ることを考えてみよう．ポイントは**```逆転項目```**の存在である．以下の示すのが項目リストだが，末尾に(*)の付されている項目は，回答した数値が大きいほど孤独感が「低い」ことを示す．これが逆転項目である．「イエス・テンデンシー」（なんでも「はい」と答えてしまいやすい傾向）を排除するため，尺度にはよくこうした「逆転項目」が敢えて含められていることが多い．一種の「努力の最小限化」防御策であるともいえる．    

```
孤独感1　周囲と調子よくいっている(*)
孤独感2　人とのつきあいがない
孤独感3　ひとりぼっちではない(*)
孤独感4　仲間の中で欠かせない存在だ(*)
孤独感5　周囲の人たちと共通点が多い(*)
孤独感6　誰とも親しくしていない
孤独感7　興味や考えが周囲の人と違う
孤独感8　頼りにできる人がいない
孤独感9　外出好きだ(*)
孤独感10　親密感を持てる人たちがいる(*)
孤独感11　無視されている
孤独感12　社会的つながりはうわべだけだ
孤独感13　私をよく知っている人はいない
孤独感14　他の人から孤立している
孤独感15　望めばいつでも人とつきあえる(*)
孤独感16　私を理解してくれる人がいる(*)
孤独感17　引っ込み思案でみじめだ
孤独感18　知人はいるが同じ考えの人はいない
孤独感19　話しかけられる人がいる(*)
孤独感20　頼りにできる人がいる(*)
```

孤独感は1から4の4件法で測定されている．得点が高ければ高いほど孤独感が高いことをあらわす合成変数を作成するためには，逆転項目は，1→4，2→3，3→2，4→1という変換をしなければならない．つまり，**```5から回答値を引いた```**新たな変数を作る必要がある．  
  
Rのコマンドは次のようである． 
  
注釈：**```dat$孤独感3<-5-dat$孤独感3```**とすれば元の変数を逆転処理された状態に置き換えることができるのだが，それはなかなか危険だろう．また，逆転後の変数に新たな変数名をつける処理も当然可能だが，そうすると「孤独感」の20項目の列位置がバラバラになってしまい，合成変数を作成するコードを書くのがめんどくさくなる．  

```{r pre_composite, warning=FALSE}
# まず，逆転前の変数を，冒頭にorg（オリジナルの意）をつけた新しい変数にコピーしておく
dat$org孤独感1 <- dat$孤独感1
dat$org孤独感3 <- dat$孤独感3
dat$org孤独感4 <- dat$孤独感4
dat$org孤独感5 <- dat$孤独感5
dat$org孤独感9 <- dat$孤独感9
dat$org孤独感10 <- dat$孤独感10
dat$org孤独感15 <- dat$孤独感15
dat$org孤独感16 <- dat$孤独感16
dat$org孤独感19 <- dat$孤独感19
dat$org孤独感20 <- dat$孤独感20

# コピーした新しい変数に所定の逆転処理をしたものを，元の変数に置き換える

dat$孤独感1 <- 5-dat$org孤独感1
dat$孤独感3 <- 5-dat$org孤独感3
dat$孤独感4 <- 5-dat$org孤独感4
dat$孤独感5 <- 5-dat$org孤独感5
dat$孤独感9 <- 5-dat$org孤独感9
dat$孤独感10 <- 5-dat$org孤独感10
dat$孤独感15 <- 5-dat$org孤独感15
dat$孤独感16 <- 5-dat$org孤独感16
dat$孤独感19 <- 5-dat$org孤独感19
dat$孤独感20 <- 5-dat$org孤独感20
```

```{r compare, warning=FALSE}
table(dat$org孤独感3)
table(dat$孤独感3)
```

どうやら無事に逆転できているようだ．あとは，回答者（行）ごとに全20項目の平均値を求め，新しい変数 ```**孤独感得点**``` とすればよい．次のように書いて，基本統計量が授業資料にあるHADで算出したものと同一かどうか確認してみる（講義スライド53）．  

```{r composite, warning=FALSE}
dat$孤独感得点 <- apply(dat[,5:24],1,mean)　#特定の列範囲（5～24），1で行単位算出を指定）
summary(dat$孤独感得点)
```

なお，話が後先になったが，合成変数を作成する際は，そこに含める項目群の信頼性（内的一貫性；項目がすべて一貫して同じ特性を測定している度合い）がある程度高いことが必要条件である．内的一貫性はCronbachのα係数を算出すれば知ることができる．Rにはα係数を算出できる関数をもつパッケージがいくつかあるが，ここでは```**psyパッケージ**の**cronbach関数**```を用いる（psychパッケージのalpha関数でもよい，はず）．

```{r cronbach, warning=FALSE}
cronbach(dat[,5:24]) #新たなデータフレームのα係数を算出
# alpha(dat[,5:24]) これがなぜかうまく実行できない（このチャンクだけなら実行できるのに…）
```

α係数は0～1までの値をとり，1に近ければ近いほど高い内的一貫性があることを示す統計量である．0.90という値は十分に高いと言ってよい．  
  
これと同じ要領で，主観的幸福感，性格の5因子それぞれについても，合成変数を作成しておく．そしてここからは，それらの合成変数がすべて作成できた後のデータセット**```dat2; ファイル名は 2018psychometrics3_2.csv```**を使って話を進めることにする．念のため，ちゃんと合成変数ができてるかどうかを確認しておこう（講義スライド53,54）．

```{r confirmation, warning=FALSE}
apply(dat2[,60:66],2,summary) #7つの合成変数（60～66列）の基本統計量を算出
describe(dat2[,60:66]) #7つの合成変数（60～66列）の基本統計量を算出
```

---

## 変数間の関係を知る

変数間の関係を記述するためには，量的変数の場合は散布図を描き，相関係数を算出する．質的変数の場合はクロス集計表を作成し，連関係数（CramerのVなど）を算出する．

### 散布図と相関係数

ここでは，孤独感と主観的幸福感の関係について見てみよう．  

```{r corr, warning=FALSE}
cor(dat2$主観的幸福感得点,dat2$孤独感得点)  #単に相関係数を求める
cor.test(dat2$主観的幸福感得点,dat2$孤独感得点) #上記に有意性検定も含める(psy/psychパッケージ)
plot(dat2$主観的幸福感得点,dat2$孤独感得点) #普通の散布図を描く

```

相関係数の値は-1から+1までの値をとり，符号は正負を表し，絶対値の大きさが関連の強さを表す．孤独感と主観的幸福感は中程度の負の相関を持っていることが分かる．HADの結果と照合しておこう（スライド62）．  

### おまけ：ちょっとカッコイイ散布図を描く

散布図はplot関数を使えば描けるのだが，もっと美しくできないか，と思う人もいるかもしれない．というわけで**```ggplot2```**というパッケージを使ってそんな試みをしてみよう．

```{r scatter1, warning=FALSE}
scatter1 <- ggplot(dat2, aes(x=主観的幸福感得点, y=孤独感得点)) #散布図を構成する変数の指定
scatter1 <- scatter1 + geom_point() #データポイントの描画
scatter1 <- scatter1 + coord_cartesian(xlim = c(0, 100), ylim = c(1, 4)) #XY軸の値範囲の指定

scatter1 #散布図の出力
```

他の変数の値によって色分けすることもできる．例えばここでは愛着スタイルによって色分けしてみよう．  
```{r scatter2, warning=FALSE}
scatter2 <- ggplot(dat2, aes(x=主観的幸福感得点, y=孤独感得点))
scatter2 <- scatter2 + geom_point(aes(colour=愛着スタイル))　#データポイントを愛着スタイルによって色分けして描画（愛着スタイルがカテゴリ変数だが数値だという場合はfactor(愛着スタイルとしてそれを宣言する必要あり）
scatter2 <- scatter2 + coord_cartesian(xlim = c(0, 100), ylim = c(1, 4)) #XY軸の値範囲の指定

scatter2 #散布図の出力
```

回帰直線と95%信頼区間も表示させたりして．  
```{r scatter3, warning=FALSE}
scatter3 <- ggplot(dat2, aes(x=主観的幸福感得点, y=孤独感得点))
scatter3 <- scatter3 + geom_point(aes(colour=愛着スタイル))
scatter3 <- scatter3 + stat_smooth(method = "lm", colour = "black", size = 1) #回帰直線を引く．se=FALSEを加えて95%信頼区間を表示させないこともできる
scatter3 <- scatter3 + coord_cartesian(xlim = c(0, 100), ylim = c(1, 4)) #XY軸の値範囲の指定

scatter3 #散布図の出力
```

グループごとの回帰直線と95%信頼区間も表示させたりして．  
```{r scatter4, warning=FALSE}
scatter4 <- ggplot(dat2, aes(x=主観的幸福感得点, y=孤独感得点))
scatter4 <- scatter4 + geom_point(aes(colour=愛着スタイル))
scatter4 <- scatter4 + stat_smooth(method = "lm", colour = "black", size = 1, aes(fill = 愛着スタイル)) #愛着スタイルごとの回帰直線を引く．se=FALSEを加えて95%信頼区間を表示させないこともできる
scatter4 <- scatter4 + coord_cartesian(xlim = c(0, 100), ylim = c(1, 4)) #XY軸の値範囲の指定

scatter4 #散布図の出力
```

こんな風にいろいろ遊べます．  

### カイ2乗検定（分布の偏りの検定，クロス表の検定）

ここでは，性別と愛着スタイルの関係（愛着スタイルの分布が性別によって異なるかどうかの検討）をする．その前にまず，データ全体で愛着スタイルの分布に偏りが見られるかどうかを検討しよう．そのための検定は**```適合度の検定```**（あるいは一様性の検定）と呼ばれる．  

```
chisq.test(dat2$愛着スタイル) ではうまくいかない．
計算せずにできるパッケージあんのか？
```

次に，性別によって愛着スタイルの分布が異なるかどうかを検討する．この検定は**```独立性の検定```**と呼ばれる．ここでは，性別によって愛着スタイルの分布が異なるという結果が示されたので，残差分析を行っている．  

```{r chitest2, warning=FALSE}
tab <- table(dat2$性別,dat2$愛着スタイル) #度数分布表を作成し，カイ2乗検定をするためにそれをtabとする

#連関係数（クラメールのV）算出のための下準備
N <- sum(tab) #総度数を算出してそれをNとする
m <- min(length(table(dat2$性別)),length(table(dat2$愛着スタイル)))  #処理の中身の記述が必要

cramer <- (chisq.test(tab)$statistic / (N*(m-1)))^0.5 #連関係数の算出
attr(cramer,"names") = "cramer's V" #連関係数cramerの出力に名前をつける

tab #度数分布表を出力する

chisq_test <- chisq.test(tab)  #独立性の検定をして残差分析のためにそれをchisq_testとする

chisq_test$residuals #残差の算出と出力
chisq_test$residuals/sqrt(outer(1-rowSums(tab)/sum(tab), 1-colSums(tab)/sum(tab))) #調整済み標準化残差の算出

cramer #連関係数の出力

```

HADの出力と同じであることはスライド80と81で確認できる．  

---

## 2群の平均値の差の検定

### 対応のない場合

次に，2群の平均値の差が統計的に有意かどうかを検討する分析を実施する．2群に対応がある(between)場合とない場合(within)で方法が異なる． 

まずここでは前者を採り上げる．孤独感得点に性差があるかどうかを検討し，効果量を算出する．効果量の算出ができるパッケージには**```effsize```**などがある．  

```{r ttest, warning=FALSE}
t.test(dat2$孤独感得点~dat2$性別) #Welchの検定
t.test(dat2$孤独感得点~dat2$性別, var.equal=TRUE) #2群の等分散性を仮定したt検定

cohen.d(dat2$孤独感得点~dat2$性別) #効果量dの算出
```

検定結果がHADの出力と同じであることはスライド94で確認できる．効果量は微妙に異なるようである．  

#### グラフを描く

```{r bargraph1, warning=FALSE}
bargraph1 <- ggplot(dat2, aes(x=性別, y=孤独感得点, fill=性別)) #XY軸を構成する変数の指定(fillは塗り分けする変数の指定)
bargraph1 <- bargraph1 + stat_summary(fun.y=mean,geom="bar",alpha=0.5) #平均値を棒グラフで描画（alphaは色の濃度）
bargraph1 <- bargraph1 + stat_summary(fun.data=mean_cl_normal,geom="errorbar",alpha=0.7,size=0.3,width=0.3) #エラーバーを標準誤差で描画（widthやsizeはエラーバーの見かけ調整）
bargraph1 <- bargraph1 + coord_cartesian(ylim = c(1, 4)) #Y軸の値範囲指定

bargraph1 #棒グラフの出力
```

その他の変数についてもWelchの検定をし，効果量を算出しておく（HADとの一致はスライド108で確認すること）．グラフも同様の手続きで描ける．  

```{r ttest2, warning=FALSE}
t.test(dat2$主観的幸福感得点~dat2$性別) #Welchの検定
cohen.d(dat2$主観的幸福感得点~dat2$性別) #効果量dの算出

t.test(dat2$誠実性得点~dat2$性別) #Welchの検定
cohen.d(dat2$誠実性得点~dat2$性別) #効果量dの算出

t.test(dat2$調和性得点~dat2$性別) #Welchの検定
cohen.d(dat2$調和性得点~dat2$性別) #効果量dの算出

t.test(dat2$神経症傾向得点~dat2$性別) #Welchの検定
cohen.d(dat2$神経症傾向得点~dat2$性別) #効果量dの算出

t.test(dat2$開放性得点~dat2$性別) #Welchの検定
cohen.d(dat2$開放性得点~dat2$性別) #効果量dの算出

t.test(dat2$外向性得点~dat2$性別) #Welchの検定
cohen.d(dat2$外向性得点~dat2$性別) #効果量dの算出
```

### 対応のある場合

ここでは別のサンプルデータ **```dat3; ファイル名はpaired_samle.csv```** を用いる．このデータは，「大学生活に不安を感じることはありますか」（1けっしてない，2どちらかといえばない，3どちらかといえば感じる,4たびたび感じる）という設問に，64名の大学生が2017年5月と2018年5月の2回にわたって回答したものである．まず2群の平均値（など基本統計量）を算出し，対応のあるt検定をして，その効果量を算出している．  

```{r ttest3, warning=FALSE}
describe(dat3) #dat3の中身を確認する
t.test(dat3$anx2017, dat3$anx2018, paired=TRUE) #対応のある2群の平均値の差の検定
cohen.d(dat3$anx2017, dat3$anx2018) #効果量dの算出
```

#### グラフを描く

**折れ線グラフをggplotで描きたいが，今のところ不器用かつ不完全な方法である**  

```{r lineplot1, warning=FALSE}

#測定年とanx2017とanx2018の平均値から成る新しいデータフレームannual.changeを作成
#測定年をfactorだと書く（year=factor(c(2017,2018))）と，グラフのX軸はちゃんとなるが折れ線グラフが出力されない
#標準誤差もデータフレームに入れたらエラーバーも出せると思うが，そのものずばりの関数がないっぽいので今のところ出してない
annual.change <- data.frame (
  year = c(2017, 2018),
  anx_mean = c(mean(dat3$anx2017), mean(dat3$anx2018))
)

annual.change #新しいデータフレームの中身の確認

lineplot1 <- ggplot(annual.change, aes(x = year, y = anx_mean))
lineplot1 <- lineplot1 + geom_line() #折れ線の描画
lineplot1 <- lineplot1 + geom_point() #データポイントの描画
lineplot1 <- lineplot1+xlab("測定年") #X軸ラベル
lineplot1 <- lineplot1+ylab("大学生活に対する不安")  #Y軸ラベル
lineplot1 <- lineplot1+coord_cartesian(ylim = c(1, 4)) #Y軸の値範囲指定
lineplot1 <- lineplot1+scale_x_continuous(breaks=seq(2017, 2018, by=1)) #X軸の値を2017と2018の1刻みに指定（対症療法）

lineplot1 #折れ線グラフの出力
```

1年が経過したことで大学生活への不安は有意に低減しているという結果が示されている．HADと結果が一致することをスライド114で確認しておこう．

---

## 分散分析

分散分析(ANOVA) 3つ以上の平均値を比較するときに用いる統計手法である．独立変数（要因）が，従属変数（結果）の散らばり具合に影響することが，データ（平均値）間に差をもたらしている程度を検討する．すべての平均値が異なる群から得られる参加者間要因，すべての平均値が同じ群から得られる参加者内要因があり，2要因以上の組み合わせであれば両者が混合することもある．分散分析の原理は講義スライドや心理科学統計IIの資料を見て理解していただきたい．  

### 参加者間1要因分散分析  

まず，愛着スタイルを独立変数，孤独感得点を従属変数とする参加者間1要因分散分析を行う．2群だった性別とは異なり，愛着スタイルは3群あるので平均値を比較する際には分散分析を用いる．分散分析を実行する関数はいくつかあるが，ここではanova関数を用いた．多重比較はHADのデフォルトのHolm法で行う．

**効果量の計算がまだ（出力を使って計算できるかな）**  

```{r anova1, warning=FALSE}
describeBy(dat2$孤独感得点,dat2$愛着スタイル) #愛着スタイルごとに孤独感得点の基本統計量を算出
anova(lm(孤独感得点~愛着スタイル, dat2)) #分散分析
pairwise.t.test (dat2$孤独感得点, dat2$愛着スタイル, p.adjust.method="holm") #Holm法による多重比較
```

愛着スタイルの主効果は有意であり，多重比較の結果から，安定型と回避型/アンビバレント型の間に差がある（回避型とアンビバレント型の間に差はない）ことが示された．HADの出力と一致していることをスライド165で確認しよう．  

#### グラフを描く

```{r bargraph2, warning=FALSE}
bargraph2 <- ggplot(dat2, aes(x=愛着スタイル, y=孤独感得点, fill=愛着スタイル)) #XY軸を構成する変数の指定(fillは塗り分けする変数の指定)
bargraph2 <- bargraph2 + stat_summary(fun.y=mean,geom="bar",alpha=0.5) #平均値を棒グラフで描画（alphaは色の濃度）
bargraph2 <- bargraph2 + stat_summary(fun.data=mean_cl_normal,geom="errorbar",alpha=0.7,size=0.3,width=0.3) #エラーバーを標準誤差で描画（widthやsizeはエラーバーの見かけ調整）
bargraph2 <- bargraph2 + coord_cartesian(ylim = c(1, 4)) #Y軸の値範囲指定

bargraph2 #棒グラフの出力
```

###参加者内1要因分散分析

ここでは別のサンプルデータ**```dat4; ファイル名はanova_sample2.csv```** を用いる．このデータは，3つの食堂のおいしさの評価(taste1, taste2, taste3を，4名の評価者がすべての店で同じメニューを食べることによって0～10の11段階で評価したものである．  

**効果量の計算がまだ（出力を使って計算できるかな）**  

```{r anova2, warning=FALSE}
dat4 #データの中身を表示
describe(dat4[,2:4]) #おいしさの評価の基本統計量

subdat4 <- list() #リストの作成というおまじない
subdat4$data <- as.vector(cbind(dat4$taste1,dat4$taste2,dat4$taste3)) #おいしさの評価（ベクトル）
subdat4$factor <- factor(c(rep("A食堂",4),rep("カフェB",4),rep("喫茶C",4))) #店の種類（文字列）
subdat4$subject <- factor(c(rep(1:4),rep(1:4),rep(1:4))) #評価者（文字列）
# subdat <- na.omit(subdat) 欠損値がある行を除く場合に必要
aov(data ~ factor+subject,subdat4) #分散分析（独立変数は店の種類と評価者（個人差））
pairwise.t.test(subdat4$data,subdat4$factor,p.adj = "holm",paired = TRUE) #Holm法による多重比較
```

#### グラフを描く

```{r bargraph3, warning=FALSE}
#店の種類とそれぞれのおいしさ評価の平均値から成る新しいデータフレームshop.diffを作成．あとは対応のある平均値の差の検定の折れ線グラフと同じ要領
shop.diff <- data.frame (
  shop = factor(c("A食堂", "カフェB", "喫茶C")),
  taste_mean = c(mean(dat4$taste1), mean(dat4$taste2), mean(dat4$taste3))
)

shop.diff #新しいデータフレームの中身の確認

#棒グラフの描画
bargraph3 <- ggplot(shop.diff, aes(x = shop, y = taste_mean, fill = shop))
bargraph3 <- bargraph3 + geom_bar(stat = "identity",alpha=0.5) #棒グラフの値として既に集計されている値を用いる時はstat="identity"を指定する必要あり）
bargraph3 <- bargraph3+xlab("店の種類") #X軸ラベル
bargraph3 <- bargraph3+ylab("おいしさ評価")  #Y軸ラベル
bargraph3 <- bargraph3+coord_cartesian(ylim = c(0, 10)) #Y軸の値範囲指定

bargraph3 #棒グラフの出力
```

分散分析の結果，店の種類によりおいしさの評価に違いがあるということがわかった．多重比較の結果，おいしさの評価は喫茶C＞A食堂＞カフェBであることがわかった．HADの出力と一致していることをスライド174/176で確認しよう．  


###参加者間2要因分散分析  

では次に，元のサンプルデータに戻って，性別と愛着スタイルを独立変数，孤独感得点を従属変数とする参加者間2要因分散分析を行ってみよう．

```
not yet
```

###参加者内2要因分散分析  

```
not yet
```

###混合2要因分散分析

```
not yet
```

---

##回帰分析

回帰分析は，2つ以上の観測変数について，1つの変数を結果，その他の変数を原因として，それらの因果関係を説明しようとする分析である．原因系の変数＝独立変数(x)と結果系の変数＝従属変数(y)に関してデータを採り，xにもとづいてyを予測する式y=f(x)を作成する．想定される原因（独立変数）が1つの場合を単回帰分析，複数の場合を重回帰分析とよぶ．  

ここではごくシンプルなモデルで分析実習をする，サンプルデータを用いて，孤独感得点を従属変数，性別・年齢・性格の5因子の各得点を独立変数とする重回帰分析をおこなってみよう．

```{r multireg1, warning=FALSE}
subdat2 <- subset(dat2, select = c(性別,年齢,孤独感得点,誠実性得点,調和性得点,神経症傾向得点,開放性得点,外向性得点)) #必要な変数だけを取り出す
multireg1 <- lm(孤独感得点~性別+年齢+誠実性得点+調和性得点+神経症傾向得点+開放性得点+外向性得点, subdat2) #重回帰分析をして結果をmultireg1に渡す
summary(multireg1) #結果の出力
```

**切片だけ値が違うのはなぜ…**
**VIFを出力**
